<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Tasker_App.Converters"
             x:Class="Tasker_App.MainPage"
             BackgroundColor="#0F1419"
             Padding="16">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:PercentageToProgressConverter x:Key="PercentageToProgressConverter" />
            <converters:StringToColorConverter x:Key="StringToColorConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            <converters:TaskCompletionColorConverter x:Key="TaskCompletionColorConverter" />
            <converters:TaskTextColorConverter x:Key="TaskTextColorConverter" />
            <converters:TaskTextDecorationConverter x:Key="TaskTextDecorationConverter" />
            <converters:FilterButtonColorConverter x:Key="FilterButtonColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Grid rows:
         0 = header
         1 = categories label + add category button (same row)
         2 = categories carousel
         3 = filter buttons row
         4 = tasks list (fills remaining)
         5 = Add Task button (fixed at bottom)
    -->
    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto" RowSpacing="10">

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Padding="6">
            <Label Grid.Column="0" Text="TASKER" FontSize="22" FontAttributes="Bold" TextColor="White" VerticalOptions="Center" />
            <Label Grid.Column="1" Text="{Binding TotalTasksCount, StringFormat='Total: {0}'}" FontSize="14" TextColor="#A0A0A0" VerticalOptions="Center" HorizontalOptions="End" />
        </Grid>

        <!-- Categories label & Add Category button -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" VerticalOptions="Center">
            <Label Grid.Column="0" Text="CATEGORIES" FontSize="14" FontAttributes="Bold" TextColor="White" VerticalOptions="Center" />
            <Button Grid.Column="1" Text="AddCategory " Command="{Binding AddCategoryCommand}" BackgroundColor="#4A7BA7" TextColor="White" CornerRadius="8" HeightRequest="36" WidthRequest="120" HorizontalOptions="End"/>
        </Grid>

        <!-- Categories carousel -->
        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding Categories}"
                        SelectionMode="Single"
                        SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                        HeightRequest="140"
                        ItemsLayout="HorizontalList"
                        Margin="0,4,0,0">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame WidthRequest="300"
                           HeightRequest="120"
                           Margin="0,0,12,0"
                           Padding="12"
                           HasShadow="False"
                           CornerRadius="8"
                           BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}}"
                           BorderColor="#233238">
                        <Grid RowDefinitions="Auto,Auto,Auto">
                            <Label Text="{Binding Name}" FontSize="16" FontAttributes="Bold" TextColor="White" />
                            <Label Grid.Row="1" Text="{Binding ProgressText, StringFormat='Progress: {0}'}" FontSize="12" TextColor="#D0D0D0" Margin="0,6,0,0" />
                            <Grid Grid.Row="2" ColumnDefinitions="*,Auto" Margin="0,10,0,0" VerticalOptions="End">
                                <ProgressBar Grid.Column="0"
                                             Progress="{Binding ProgressPercentage, Converter={StaticResource PercentageToProgressConverter}}"
                                             ProgressColor="{Binding ColorCode, Converter={StaticResource StringToColorConverter}}"
                                             BackgroundColor="#1E2830"
                                             HeightRequest="8" VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       Text="{Binding TaskCount, StringFormat='{0} Tasks'}"
                                       FontSize="12"
                                       TextColor="White"
                                       VerticalOptions="Center"
                                       HorizontalOptions="End"
                                       Margin="10,0,0,0" />
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Filter buttons row: Horizontal buttons with width and height -->
        <HorizontalStackLayout Grid.Row="3" Spacing="12" Margin="0,6,0,0" VerticalOptions="Center">
            <Button Text="All"
                    Command="{Binding FilterTasksCommand}"
                    CommandParameter="all"
                    BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter=all}"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="44"
                    WidthRequest="110"/>
            <Button Text="Pending"
                    Command="{Binding FilterTasksCommand}"
                    CommandParameter="pending"
                    BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter=pending}"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="44"
                    WidthRequest="110"/>
            <Button Text="Done"
                    Command="{Binding FilterTasksCommand}"
                    CommandParameter="done"
                    BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter=done}"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="44"
                    WidthRequest="110"/>
        </HorizontalStackLayout>

        <!-- Tasks list: takes remaining height, with bottom padding so Add Task does not overlap -->
        <CollectionView Grid.Row="4"
                        ItemsSource="{Binding FilteredTasks}"
                        SelectionMode="None"
                        VerticalOptions="FillAndExpand"
                        Margin="0,8,0,8">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame HasShadow="False"
                           CornerRadius="8"
                           Padding="12"
                           Margin="0,0,0,0"
                           BackgroundColor="{Binding IsCompleted, Converter={StaticResource TaskCompletionColorConverter}}"
                           BorderColor="#2E3A42">
                        <Grid RowDefinitions="Auto,Auto">
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <CheckBox IsChecked="{Binding IsCompleted}" CheckedChanged="OnTaskCheckChanged" VerticalOptions="Center" />
                                <StackLayout Grid.Column="1" Spacing="2">
                                    <Label Text="{Binding Title}" FontSize="14" FontAttributes="Bold" TextColor="{Binding IsCompleted, Converter={StaticResource TaskTextColorConverter}}" TextDecorations="{Binding IsCompleted, Converter={StaticResource TaskTextDecorationConverter}}" />
                                    <Label Text="{Binding CategoryName}" FontSize="11" TextColor="#D0D0D0" />
                                </StackLayout>

                                <HorizontalStackLayout Grid.Column="2" Spacing="8" VerticalOptions="Center">
                                    <Button Text="Edit" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditTaskCommand}" CommandParameter="{Binding .}" BackgroundColor="Transparent" TextColor="White" WidthRequest="36" HeightRequest="36"/>
                                    <Button Text="Delete" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTaskCommand}" CommandParameter="{Binding .}" BackgroundColor="Transparent" TextColor="White" WidthRequest="36" HeightRequest="36"/>
                                </HorizontalStackLayout>
                            </Grid>

                            <Label Grid.Row="1" Text="{Binding CreatedDate, StringFormat='{0:MMM d, yyyy h:mm tt}'}" FontSize="11" TextColor="#A0A0A0" Margin="0,8,0,0" />
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Add Task button fixed at bottom -->
        <Grid Grid.Row="5" Padding="0,8,0,8">
            <Button Text="+ Add Task" Command="{Binding AddTaskCommand}" BackgroundColor="#4A7BA7" TextColor="White" CornerRadius="10" HeightRequest="48" HorizontalOptions="Fill" VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>