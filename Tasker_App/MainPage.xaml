<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Tasker_App.MainPage"
             BackgroundColor="#0F1419"
             Padding="0">

    <ContentPage.Resources>
        <ResourceDictionary xmlns:local="clr-namespace:Tasker_App.Converters">
            <local:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <local:FilterButtonColorConverter x:Key="FilterButtonColorConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="60,*" BackgroundColor="#0F1419">

        <!-- Header -->
        <Grid Grid.Row="0" BackgroundColor="#1B4965" Padding="20,0">
            <Label Text="TASKER" 
                   FontSize="24"        
                   FontAttributes="Bold" 
                   TextColor="White" 
                   VerticalOptions="Center"/>
        </Grid>

        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*" RowDefinitions="Auto,*,Auto" Padding="15">

            <!-- Categories Section -->
            <StackLayout Grid.Row="0" Spacing="10">
                <Label Text="CATEGORIES" 
                       FontSize="16" 
                       FontAttributes="Bold" 
                       TextColor="White"/>

                <!-- Categories Collection View -->
                <CollectionView x:Name="CategoriesCollectionView" 
                               SelectionMode="Single"
                               SelectedItem="{Binding SelectedCategory}"
                               ItemsSource="{Binding Categories}"
                               SelectionChangedCommand="{Binding CategorySelectionChangedCommand}"
                               SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame BorderColor="#4A7BA7" 
                                   CornerRadius="8" 
                                   HasShadow="False"
                                   Padding="0"
                                   Margin="0"
                                   BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}}"
                                   >
                                <Grid ColumnDefinitions="*,Auto" Padding="15,12">
                                    <StackLayout Grid.Column="0" Spacing="5">
                                        <Label Text="{Binding Name}" 
                                               FontSize="14" 
                                               FontAttributes="Bold" 
                                               TextColor="White"/>
                                        <BoxView BackgroundColor="{Binding ColorCode}" 
                                                WidthRequest="40" 
                                                HeightRequest="3" 
                                                CornerRadius="2"/>
                                    </StackLayout>

                                    <!-- Replaced Label-with-CornerRadius by a Frame that supports CornerRadius -->
                                    <Frame Grid.Column="1"
                                           BackgroundColor="#2C3E50"
                                           CornerRadius="4"
                                           Padding="8,4"
                                           HasShadow="False"
                                           VerticalOptions="Center">
                                        <Label Text="{Binding TaskCount, StringFormat='{0} Tasks'}"
                                               FontSize="12"
                                               TextColor="White"/>
                                    </Frame>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Add Category Button -->
                <Button Text="+ Add Category" 
                       Command="{Binding AddCategoryCommand}" 
                       BackgroundColor="#4A7BA7" 
                       TextColor="White" 
                       CornerRadius="8" 
                       Padding="15,10" 
                       FontSize="12"/>
            </StackLayout>

            <!-- Filter and Tasks Section -->
            <StackLayout Grid.Row="1" Spacing="10" Margin="0,20,0,0">
                <Label Text="PENDING TASK" 
                       FontSize="16" 
                       FontAttributes="Bold" 
                       TextColor="White"/>

                <!-- Filter Buttons -->
                <HorizontalStackLayout Spacing="10">
                    <Button Text="All" 
                           Command="{Binding FilterTasksCommand}" 
                           CommandParameter="all"
                           BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter='all'}" 
                           TextColor="White" 
                           CornerRadius="6" 
                           Padding="12,8" 
                           FontSize="11"/>
                    <Button Text="Pending" 
                           Command="{Binding FilterTasksCommand}" 
                           CommandParameter="pending"
                           BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter='pending'}" 
                           TextColor="White" 
                           CornerRadius="6" 
                           Padding="12,8" 
                           FontSize="11"/>
                    <Button Text="Done" 
                           Command="{Binding FilterTasksCommand}" 
                           CommandParameter="done"
                           BackgroundColor="{Binding FilterStatus, Converter={StaticResource FilterButtonColorConverter}, ConverterParameter='done'}" 
                           TextColor="White" 
                           CornerRadius="6" 
                           Padding="12,8" 
                           FontSize="11"/>
                </HorizontalStackLayout>

                <!-- Tasks Collection View -->
                <CollectionView x:Name="TasksCollectionView" 
                               ItemsSource="{Binding FilteredTasks}"
                               SelectionMode="Single">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>       
                        <DataTemplate>
                            <Frame BorderColor="#4A7BA7" 
                                   CornerRadius="8" 
                                   HasShadow="False"
                                   Padding="0"
                                   Margin="0"
                                   BackgroundColor="#4A7BA7">
                                <Grid ColumnDefinitions="Auto,*,Auto" Padding="15,12" ColumnSpacing="12">
                                    <CheckBox Grid.Column="0" 
                                             IsChecked="{Binding IsCompleted}"
                                             VerticalOptions="Center"/>
                                    <StackLayout Grid.Column="1" Spacing="5">
                                        <Label Text="{Binding Title}" 
                                               FontSize="14" 
                                               FontAttributes="Bold" 
                                               TextColor="White"/>
                                        <Label Text="{Binding CategoryName}" 
                                               FontSize="11" 
                                               TextColor="#D0D0D0"/>
                                    </StackLayout>
                                    <Grid Grid.Column="2" ColumnDefinitions="Auto,Auto" ColumnSpacing="8" VerticalOptions="Center">
                                        <Button Grid.Column="0" 
                                               Text="✎" 
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditTaskCommand}"
                                               CommandParameter="{Binding .}"
                                               BackgroundColor="Transparent" 
                                               TextColor="White" 
                                               FontSize="16" 
                                               Padding="5" 
                                               CornerRadius="4"/>
                                        <Button Grid.Column="1" 
                                               Text="✕" 
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteTaskCommand}"
                                               CommandParameter="{Binding .}"
                                               BackgroundColor="Transparent" 
                                               TextColor="#FF6B6B" 
                                               FontSize="16" 
                                               Padding="5" 
                                               CornerRadius="4"/>
                                    </Grid>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>

            <!-- Add Task Button -->
            <Button Grid.Row="2" 
                   Text="+ Add Task" 
                   Command="{Binding AddTaskCommand}" 
                   BackgroundColor="#4A7BA7" 
                   TextColor="White" 
                   CornerRadius="8" 
                   Padding="15,10" 
                   FontSize="12"
                   Margin="0,15,0,0"/>
        </Grid>
    </Grid>
</ContentPage>